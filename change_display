#!/usr/bin/env python3

import os
import argparse
import re

HOME = os.environ['HOME']

paths = {
    'latte_config': HOME + '/.config/latte/Default.layout.latte',
    'cursor_config': HOME + '/.config/kcminputrc',
    'scaling_config': HOME + '/.config/kdeglobals',
    'font_config': HOME + '/.config/kcmfonts',
    'rofi_config': HOME + '/.config/rofi/config.rasi'
}

laptop_settings = {
    # Settings for laptop (hidpi) display
    'latte_dock_size': '86',
    'latte_panel_size': '36',
    'latte_screen_edge_margin': '16',
    'cursor_size': '48',
    'scaling': '2',
    'force_font_dpi': '192',
    'screen_scale_factors': 'eDP-1=2;DP-1=2;DP-2=2;DP-3=2;',
    'rofi_fontsize': '20'
}

external_settings = {
    # Settings for external display
    'latte_dock_size': '48',
    'latte_panel_size': '18',
    'latte_screen_edge_margin': '8',
    'cursor_size': '24',
    'scaling': '1',
    'force_font_dpi': '96',
    'screen_scale_factors': 'eDP-1=1;DP-1=1;DP-2=1;',
    'rofi_fontsize': '10'
}


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("display", help="Define the display to target", choices=[
                        'laptop', 'external'])
    args = parser.parse_args()

    if args.display == 'laptop':
        settings = laptop_settings

    if args.display == 'external':
        settings = external_settings

    apply_kde_config(settings)
    apply_rofi_config(settings)
    print('Settings applied. Please log out and back in if you\'re inside an active session')


def apply_kde_config(settings):
    config = {**paths, **settings}

    # Configure latte dock
    os.system(
        'kwriteconfig5 --file {latte_config} --group "Containments" --group "1" --group "General" --key "iconSize" "{latte_dock_size}"'.format(**config))

    # Configure latte panel
    os.system(
        'kwriteconfig5 --file {latte_config} --group "Containments" --group "4" --group "General" --key "iconSize" "{latte_panel_size}"'.format(**config))
    os.system(
        'kwriteconfig5 --file {latte_config} --group "Containments" --group "4" --group "General" --key "screenEdgeMargin" "{latte_screen_edge_margin}"'.format(**config))

    # Configure cursor scaling
    os.system(
        'kwriteconfig5 --file {cursor_config} --group "Mouse" --key "cursorSize" "{cursor_size}"'.format(**config))

    # Configure display scaling
    os.system(
        'kwriteconfig5 --file {scaling_config} --group "KScreen" --key "ScaleFactor" "{scaling}"'.format(**config))
    os.system(
        'kwriteconfig5 --file {scaling_config} --group "KScreen" --key "ScreenScaleFactors" "{screen_scale_factors}"'.format(**config))
    os.system(
        'kwriteconfig5 --file {font_config} --group "General" --key "forceFontDPI" "{force_font_dpi}"'.format(**config))


def apply_rofi_config(settings):
    # Configure rofi settings
    config = {**paths, **settings}

    with open(config['rofi_config'], 'r') as f:
        lines = f.readlines()
    with open(config['rofi_config'], 'w') as f:
        for line in lines:
            f.write(re.sub(
                r'Noto Sans [0-9][0-9]', 'Noto Sans {rofi_fontsize}'.format(**config), line))


if __name__ == "__main__":
    # execute only if run as a script
    main()
